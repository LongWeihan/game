<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éœ“è™¹çªè¢­ - æˆ˜äº‰ç»æµç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
        }
        canvas { display: block; }
        
        /* éœ“è™¹ç‰¹æ•ˆç±» */
        .neon-text { text-shadow: 0 0 10px rgba(0, 255, 255, 0.7), 0 0 20px rgba(0, 255, 255, 0.5); }
        .neon-text-purple { text-shadow: 0 0 10px rgba(168, 85, 247, 0.7), 0 0 20px rgba(168, 85, 247, 0.5); }
        .neon-text-orange { text-shadow: 0 0 10px rgba(249, 115, 22, 0.7), 0 0 20px rgba(249, 115, 22, 0.5); }
        .neon-text-green { text-shadow: 0 0 10px rgba(34, 197, 94, 0.7), 0 0 20px rgba(34, 197, 94, 0.5); }
        .neon-box { box-shadow: 0 0 15px rgba(6, 182, 212, 0.2), inset 0 0 10px rgba(6, 182, 212, 0.1); }
        
        #ui-layer { transition: opacity 0.3s ease; }
        .hidden { opacity: 0; pointer-events: none; display: none !important; }
        body { cursor: crosshair; }
        
        /* æ ¸å¼¹ç™½å±ç‰¹æ•ˆ */
        #flash-layer { pointer-events: none; mix-blend-mode: screen; }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* å•†åº—å¡ç‰‡ */
        .shop-card {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(74, 222, 128, 0.3);
            transition: all 0.2s;
            cursor: pointer;
        }
        .shop-card:hover {
            background: rgba(74, 222, 128, 0.1);
            border-color: rgba(74, 222, 128, 0.8);
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(74, 222, 128, 0.2);
        }
        .shop-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }
        
        /* å¸®åŠ©èœå•æ­¦å™¨å¡ç‰‡ */
        .weapon-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }
        .weapon-card:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(0, 255, 255, 0.3);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>

    <!-- æ ¸å¼¹é—ªå…‰å±‚ -->
    <div id="flash-layer" class="absolute inset-0 bg-white opacity-0 z-50 transition-opacity duration-1000"></div>

    <!-- æ¸¸æˆ UI å±‚ -->
    <div id="ui-layer" class="absolute inset-0 z-10 pointer-events-none">
        
        <!-- é¡¶éƒ¨ HUD -->
        <div class="absolute top-0 left-0 w-full p-6 flex justify-between items-start">
            <!-- å·¦ä¾§ï¼šåˆ†æ•°ä¸èµ„æº -->
            <div class="flex flex-col gap-2">
                <div>
                    <span class="text-xs text-gray-400 tracking-widest uppercase">SCORE</span>
                    <div id="scoreEl" class="text-3xl font-bold text-cyan-400 neon-text">0</div>
                </div>
                <div class="flex gap-6 mt-2">
                    <div>
                        <span class="text-xs text-gray-400 tracking-widest uppercase">CREDITS</span>
                        <div class="flex items-center text-green-400 neon-text-green">
                            <span class="text-xl mr-1">$</span>
                            <span class="text-2xl font-bold" id="creditsEl">0</span>
                            <span class="text-[10px] ml-2 border border-green-500/50 px-1 rounded text-green-300 bg-green-900/30">æŒ‰ B è´­ç‰©</span>
                        </div>
                    </div>
                    <div>
                        <span class="text-xs text-gray-400 tracking-widest uppercase">NANO-MATS</span>
                        <div class="flex items-center text-orange-400 neon-text-orange">
                            <span class="text-xl mr-1">âš™</span>
                            <span class="text-2xl font-bold" id="materialEl">0</span>
                            <span class="text-[10px] ml-2 border border-orange-500/50 px-1 rounded text-orange-300 bg-orange-900/30">å³é”®å»ºé€ </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ä¸­é—´ï¼šæ­¦å™¨çŠ¶æ€ -->
            <div class="absolute left-1/2 -translate-x-1/2 top-6 flex flex-col items-center">
                <div class="text-xs text-gray-400 tracking-widest uppercase mb-1">WEAPON SYSTEM</div>
                <div class="flex items-center space-x-4 bg-gray-900/90 backdrop-blur px-8 py-3 rounded-full border border-gray-700 neon-box transform scale-110">
                    <span id="weaponName" class="text-xl font-bold text-yellow-400">PISTOL</span>
                    <div class="h-8 w-px bg-gray-600"></div>
                    <span id="ammoEl" class="text-2xl font-mono text-white">âˆ</span>
                </div>
                <!-- ç‚®å°çŠ¶æ€ -->
                <div id="turretStatus" class="mt-2 text-xs text-gray-500 opacity-0 transition-opacity">
                    [E] éƒ¨ç½²ç‚®å° (<span id="turretCount">0</span>)
                </div>
            </div>

            <!-- å³ä¾§ï¼šç”Ÿå‘½å€¼ -->
            <div class="flex flex-col items-end">
                 <span class="text-xs text-gray-400 tracking-widest uppercase">INTEGRITY</span>
                 <div class="w-56 h-5 bg-gray-800 rounded-full overflow-hidden border border-gray-700 mt-2 relative shadow-lg">
                     <div id="healthBar" class="h-full bg-gradient-to-r from-cyan-500 to-blue-600 w-full transition-all duration-200"></div>
                     <!-- æŠ¤ç›¾å±‚ -->
                     <div id="shieldBar" class="absolute top-0 left-0 h-full bg-blue-400/50 w-0 transition-all duration-200"></div>
                 </div>
                 <div id="healthText" class="mt-1 text-xs font-mono text-cyan-300">100%</div>
            </div>
        </div>

        <!-- æ‹¾å–æç¤º -->
        <div id="pickupMsg" class="absolute top-40 w-full text-center transition-opacity duration-500 opacity-0">
            <div class="inline-block bg-black/70 text-white px-6 py-3 rounded-lg border border-white/20 backdrop-blur transform scale-110">
                <span id="pickupIcon" class="text-2xl mr-2">ğŸ</span>
                è·å¾— <span id="pickupName" class="font-bold text-yellow-400">ç‰©å“</span>
            </div>
        </div>

        <!-- å•†åº—èœå• (è¦†ç›–å±‚) -->
        <div id="shopMenu" class="absolute inset-0 bg-black/80 backdrop-blur-sm z-[55] pointer-events-auto flex flex-col items-center justify-center hidden">
            <div class="w-full max-w-5xl bg-gray-900 border border-green-500/30 rounded-2xl overflow-hidden shadow-[0_0_50px_rgba(34,197,94,0.1)]">
                <!-- Header -->
                <div class="p-6 border-b border-green-900/50 flex justify-between items-center bg-black/40">
                    <div class="flex items-center gap-4">
                        <h2 class="text-3xl font-black text-green-400 tracking-widest italic">BLACK MARKET</h2>
                        <div class="px-3 py-1 bg-green-900/30 rounded border border-green-500/30 text-green-300 text-sm">
                            å½“å‰ä¿¡ç”¨ç‚¹: $<span id="shopCredits">0</span>
                        </div>
                    </div>
                    <div class="text-gray-400 text-sm">æŒ‰ [B] æˆ– [ESC] å…³é—­</div>
                </div>
                
                <!-- Items Grid -->
                <div class="p-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- å•†å“ -->
                    <div class="shop-card p-5 rounded-xl flex flex-col relative group" onclick="buyItem('repair')">
                        <div class="text-4xl mb-3">âœš</div>
                        <h3 class="text-xl font-bold text-white">ç´§æ€¥ä¿®å¤åè®®</h3>
                        <p class="text-sm text-gray-400 mb-4">ç«‹å³ä¿®å¤å—æŸæœºä½“ï¼Œæ¢å¤ 50 ç‚¹ç”Ÿå‘½å€¼ã€‚</p>
                        <div class="mt-auto flex justify-between items-center">
                            <span class="text-green-400 font-mono font-bold text-xl">$100</span>
                            <button class="px-4 py-1 bg-green-600 hover:bg-green-500 text-white rounded text-sm font-bold">è´­ä¹°</button>
                        </div>
                    </div>

                    <div class="shop-card p-5 rounded-xl flex flex-col relative group" onclick="buyItem('ammo')">
                        <div class="text-4xl mb-3">â‘Š</div>
                        <h3 class="text-xl font-bold text-white">å¼¹è¯è¡¥ç»™ç®±</h3>
                        <p class="text-sm text-gray-400 mb-4">å¡«æ»¡å½“å‰æ­¦å™¨çš„æ‰€æœ‰å¼¹è¯ (æ— é™æ­¦å™¨é™¤å¤–)ã€‚</p>
                        <div class="mt-auto flex justify-between items-center">
                            <span class="text-green-400 font-mono font-bold text-xl">$50</span>
                            <button class="px-4 py-1 bg-green-600 hover:bg-green-500 text-white rounded text-sm font-bold">è´­ä¹°</button>
                        </div>
                    </div>

                    <div class="shop-card p-5 rounded-xl flex flex-col relative group" onclick="buyItem('shield')">
                        <div class="text-4xl mb-3">ğŸ›¡</div>
                        <h3 class="text-xl font-bold text-white">ç²’å­æŠ¤ç›¾ç”µæ± </h3>
                        <p class="text-sm text-gray-400 mb-4">ä¸ºæŠ¤ç›¾å‘ç”Ÿå™¨å……èƒ½ +50% (å¯è¶…è½½)ã€‚</p>
                        <div class="mt-auto flex justify-between items-center">
                            <span class="text-green-400 font-mono font-bold text-xl">$150</span>
                            <button class="px-4 py-1 bg-green-600 hover:bg-green-500 text-white rounded text-sm font-bold">è´­ä¹°</button>
                        </div>
                    </div>

                    <div class="shop-card p-5 rounded-xl flex flex-col relative group" onclick="buyItem('turret')">
                        <div class="text-4xl mb-3 text-yellow-400">â™œ</div>
                        <h3 class="text-xl font-bold text-white">å“¨æˆ’ç‚®å°</h3>
                        <p class="text-sm text-gray-400 mb-4">å¢åŠ  1 ä¸ªè‡ªåŠ¨ç‚®å°åº“å­˜ã€‚å»ºç«‹é˜²çº¿çš„å…³é”®ã€‚</p>
                        <div class="mt-auto flex justify-between items-center">
                            <span class="text-green-400 font-mono font-bold text-xl">$200</span>
                            <button class="px-4 py-1 bg-green-600 hover:bg-green-500 text-white rounded text-sm font-bold">è´­ä¹°</button>
                        </div>
                    </div>

                    <div class="shop-card p-5 rounded-xl flex flex-col relative group" onclick="buyItem('material')">
                        <div class="text-4xl mb-3 text-orange-400">âš™</div>
                        <h3 class="text-xl font-bold text-white">çº³ç±³ææ–™åŒ…</h3>
                        <p class="text-sm text-gray-400 mb-4">è´­ä¹° 50 å•ä½çš„å»ºç­‘ææ–™ç”¨äºå»ºé€ æ©ä½“ã€‚</p>
                        <div class="mt-auto flex justify-between items-center">
                            <span class="text-green-400 font-mono font-bold text-xl">$75</span>
                            <button class="px-4 py-1 bg-green-600 hover:bg-green-500 text-white rounded text-sm font-bold">è´­ä¹°</button>
                        </div>
                    </div>

                    <div class="shop-card p-5 rounded-xl flex flex-col relative group border-red-500/30 hover:border-red-500" onclick="buyItem('nuke')">
                        <div class="text-4xl mb-3 text-red-500">â˜¢</div>
                        <h3 class="text-xl font-bold text-red-100">æˆ˜æœ¯æ ¸å¼¹å‘å°„å™¨</h3>
                        <p class="text-sm text-gray-400 mb-4">è´­ä¹°åç«‹å³å¼•çˆ†ï¼Œæ¸…é™¤å…¨å±æ•Œäººã€‚æ…ç”¨ã€‚</p>
                        <div class="mt-auto flex justify-between items-center">
                            <span class="text-red-400 font-mono font-bold text-xl">$1000</span>
                            <button class="px-4 py-1 bg-red-900 hover:bg-red-700 text-white rounded text-sm font-bold border border-red-500">æˆæƒ</button>
                        </div>
                    </div>
                </div>
                
                <div class="p-4 bg-black/60 text-center text-xs text-gray-500">
                    æˆ˜æœ¯æç¤º: å³ä½¿åœ¨å•†åº—ç•Œé¢ï¼ŒèƒŒæ™¯ä¸–ç•Œä¾ç„¶å¤„äºé™æ­¢çŠ¶æ€ (Time Frozen)ã€‚
                </div>
            </div>
        </div>

        <!-- ä¸»èœå• -->
        <div id="startMenu" class="absolute inset-0 flex items-center justify-center bg-black/90 backdrop-blur-md pointer-events-auto z-50">
            <div class="p-10 rounded-2xl border border-cyan-500/30 shadow-[0_0_60px_rgba(6,182,212,0.15)] text-center max-w-lg w-full relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-purple-500 via-cyan-500 to-purple-500 animate-pulse"></div>

                <h1 class="text-7xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 via-white to-purple-500 neon-text italic tracking-tighter">NEON RAID</h1>
                <h2 class="text-2xl text-purple-400 font-bold mb-8 tracking-[0.5em] uppercase text-shadow">Tactical</h2>
                
                <!-- Game Over Section -->
                <div id="finalScoreContainer" class="hidden mb-8 p-6 bg-red-950/40 border border-red-500/50 rounded-lg">
                    <p class="text-gray-400 text-xs uppercase tracking-widest mb-2">Mission Terminated</p>
                    <p id="finalScore" class="text-6xl font-bold text-red-500 neon-text-orange">0</p>
                </div>

                <div class="space-y-4">
                    <button id="startBtn" class="w-full py-5 bg-gradient-to-r from-cyan-700 to-purple-700 hover:from-cyan-600 hover:to-purple-600 text-white font-bold rounded-lg text-2xl transition-all shadow-[0_0_20px_rgba(168,85,247,0.4)] hover:scale-[1.02] uppercase tracking-widest group relative overflow-hidden">
                        <span class="relative z-10" id="startBtnText">INITIATE</span>
                        <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                    </button>

                    <!-- New Button: Return to Title -->
                    <button id="returnToTitleBtn" class="hidden w-full py-3 bg-gray-800 hover:bg-gray-700 text-gray-300 font-bold rounded-lg text-lg transition-all border border-gray-600 uppercase tracking-widest">
                        è¿”å›ä¸»ç•Œé¢ (Main Menu)
                    </button>
                    
                    <button id="helpBtn" class="w-full py-3 bg-gray-800 hover:bg-gray-700 text-cyan-400 font-bold rounded-lg text-lg transition-all border border-cyan-500/30 uppercase tracking-widest">
                        æˆ˜æœ¯æ‰‹å†Œ (Help)
                    </button>
                </div>
                
                <div class="mt-6 text-xs text-gray-500">
                    v 1.3.0 | ç³»ç»Ÿå°±ç»ª | ç­‰å¾…æŒ‡ä»¤
                </div>
            </div>
        </div>

        <!-- å¸®åŠ©èœå• (è¦†ç›–å±‚) -->
        <div id="helpMenu" class="absolute inset-0 bg-black/95 backdrop-blur-xl z-[60] pointer-events-auto flex flex-col items-center justify-center hidden">
            <div class="w-full max-w-4xl h-[85vh] flex flex-col bg-gray-900/50 border border-cyan-500/30 rounded-2xl overflow-hidden shadow-2xl">
                <!-- Header -->
                <div class="p-6 border-b border-gray-800 flex justify-between items-center bg-black/40">
                    <h2 class="text-3xl font-bold text-cyan-400 tracking-widest">æˆ˜æœ¯æ‰‹å†Œ TACTICAL MANUAL</h2>
                    <button id="closeHelpBtn" class="text-gray-400 hover:text-white text-4xl font-light focus:outline-none">&times;</button>
                </div>
                
                <!-- Content -->
                <div class="flex-1 overflow-y-auto p-8 space-y-8">
                    
                    <!-- 1. Controls -->
                    <section>
                        <h3 class="text-xl font-bold text-white mb-4 border-l-4 border-cyan-500 pl-3">æ“ä½œæŒ‡å— / CONTROLS</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div class="bg-gray-800/50 p-4 rounded border border-gray-700">
                                <div class="text-cyan-400 font-bold mb-1">WASD</div>
                                <div class="text-gray-400">æˆ˜æœ¯ç§»åŠ¨</div>
                            </div>
                            <div class="bg-gray-800/50 p-4 rounded border border-gray-700">
                                <div class="text-cyan-400 font-bold mb-1">MOUSE</div>
                                <div class="text-gray-400">ç„å‡†ä¸å°„å‡» (å·¦é”®)</div>
                            </div>
                            <div class="bg-gray-800/50 p-4 rounded border border-gray-700">
                                <div class="text-cyan-400 font-bold mb-1">å³é”® (Right Click)</div>
                                <div class="text-gray-400">æ¶ˆè€—10ææ–™å»ºé€ æ©ä½“</div>
                            </div>
                            <div class="bg-gray-800/50 p-4 rounded border border-gray-700">
                                <div class="text-cyan-400 font-bold mb-1">E é”® / B é”®</div>
                                <div class="text-gray-400">æ”¾ç½®ç‚®å° / æ‰“å¼€å•†åº—</div>
                            </div>
                        </div>
                    </section>

                    <!-- 2. Weapons -->
                    <section>
                        <h3 class="text-xl font-bold text-white mb-4 border-l-4 border-yellow-500 pl-3">æ­¦å™¨åº“ / ARSENAL</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="weapon-card p-4 rounded">
                                <div class="flex justify-between mb-2"><span class="font-bold text-yellow-400">æ‰‹æª</span> <span class="text-xs text-gray-500">æ— é™</span></div>
                                <p class="text-xs text-gray-400">åŸºç¡€æ­¦å™¨ï¼Œç²¾å‡†åº¦é«˜ï¼Œæ— åååŠ›ã€‚</p>
                            </div>
                            <div class="weapon-card p-4 rounded">
                                <div class="flex justify-between mb-2"><span class="font-bold text-purple-400">çªå‡»æ­¥æª</span> <span class="text-xs text-gray-500">æ™®é€š</span></div>
                                <p class="text-xs text-gray-400">å…¨è‡ªåŠ¨å°„å‡»ï¼Œé€‚åˆä¸­è·ç¦»å‹åˆ¶ã€‚</p>
                            </div>
                            <div class="weapon-card p-4 rounded">
                                <div class="flex justify-between mb-2"><span class="font-bold text-red-500">é˜²ç©ºéœ°å¼¹ç‚®</span> <span class="text-xs text-gray-500">è¿‘æˆ˜</span></div>
                                <p class="text-xs text-gray-400">ä¸€æ¬¡å‘å°„å¤šæšå¼¹ç‰‡ï¼Œè¿‘è·ç¦»çˆ†å‘æé«˜ï¼ŒåååŠ›å¤§ã€‚</p>
                            </div>
                            <div class="weapon-card p-4 rounded">
                                <div class="flex justify-between mb-2"><span class="font-bold text-green-400">åŠ ç‰¹æ—æœºæª</span> <span class="text-xs text-gray-500">ç«åŠ›</span></div>
                                <p class="text-xs text-gray-400">å°„é€Ÿæå¿«ï¼Œè½½å¼¹é‡å¤§ï¼Œä½†å¼€ç«æ—¶ä¼šé™ä½ç§»åŠ¨é€Ÿåº¦ã€‚</p>
                            </div>
                            <div class="weapon-card p-4 rounded">
                                <div class="flex justify-between mb-2"><span class="font-bold text-pink-400">å¼¹å°„å…‰ç›˜</span> <span class="text-xs text-gray-500">æˆ˜æœ¯</span></div>
                                <p class="text-xs text-gray-400">å‘å°„åœ¨å¢™å£é—´åå¼¹çš„é«˜èƒ½å…‰ç›˜ï¼Œæ¸…ç†æ­»è§’æ•Œäººã€‚</p>
                            </div>
                            <div class="weapon-card p-4 rounded">
                                <div class="flex justify-between mb-2"><span class="font-bold text-orange-500">RPG ç«ç®­ç­’</span> <span class="text-xs text-gray-500">çˆ†ç‚¸</span></div>
                                <p class="text-xs text-gray-400">é€ æˆå¤§èŒƒå›´çˆ†ç‚¸ä¼¤å®³ï¼Œèƒ½æœ‰æ•ˆæ¸…é™¤å¯†é›†çš„æ•Œäººã€‚</p>
                            </div>
                            <div class="weapon-card p-4 rounded">
                                <div class="flex justify-between mb-2"><span class="font-bold text-cyan-400">ç£è½¨ç‚® (Laser)</span> <span class="text-xs text-gray-500">ç©¿é€</span></div>
                                <p class="text-xs text-gray-400">ç¬é—´ç©¿é€ç›´çº¿ä¸Šæ‰€æœ‰æ•Œäººï¼Œä¼¤å®³æé«˜ã€‚</p>
                            </div>
                        </div>
                    </section>

                    <!-- 3. Items -->
                    <section>
                        <h3 class="text-xl font-bold text-white mb-4 border-l-4 border-blue-500 pl-3">æˆ˜æœ¯é“å…· / SUPPORT</h3>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
                            <div class="p-3 bg-gray-800/30 rounded border border-gray-700">
                                <div class="text-2xl mb-1 text-green-400">$</div>
                                <div class="text-xs font-bold text-green-400">ä¿¡ç”¨ç‚¹</div>
                                <div class="text-[10px] text-gray-500">å‡»æ€æ•Œäººè·å–ï¼Œç”¨äºè´­ç‰©</div>
                            </div>
                            <div class="p-3 bg-gray-800/30 rounded border border-gray-700">
                                <div class="text-2xl mb-1">âœš</div>
                                <div class="text-xs font-bold text-green-400">åŒ»ç–—åŒ…</div>
                                <div class="text-[10px] text-gray-500">+30 HP</div>
                            </div>
                            <div class="p-3 bg-gray-800/30 rounded border border-gray-700">
                                <div class="text-2xl mb-1">ğŸ›¡</div>
                                <div class="text-xs font-bold text-blue-400">èƒ½é‡ç›¾</div>
                                <div class="text-[10px] text-gray-500">é¢å¤–æŠ¤ç›¾</div>
                            </div>
                             <div class="p-3 bg-gray-800/30 rounded border border-gray-700">
                                <div class="text-2xl mb-1 text-yellow-400">â™œ</div>
                                <div class="text-xs font-bold text-yellow-400">è‡ªåŠ¨ç‚®å°</div>
                                <div class="text-[10px] text-gray-500">æŒ‰ E éƒ¨ç½² (æ‰è½ç‡æå‡)</div>
                            </div>
                            <div class="p-3 bg-red-900/20 rounded border border-red-500/50">
                                <div class="text-2xl mb-1 text-red-500">â˜¢</div>
                                <div class="text-xs font-bold text-red-500">æˆ˜æœ¯æ ¸å¼¹</div>
                                <div class="text-[10px] text-gray-500">å…¨å±æ¸…é™¤</div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>

    </div>

    <canvas id="gameCanvas"></canvas>

<script>
// ---------------- éŸ³ä¹ä¸éŸ³æ•ˆç³»ç»Ÿ ----------------
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const BGM = {
    isPlaying: false, tempo: 130, nextNoteTime: 0, beatCount: 0, bassNotes: [36, 36, 38, 36, 43, 43, 41, 41], timerID: null,
    start: function() { if(this.isPlaying)return; if(audioCtx.state==='suspended')audioCtx.resume(); this.isPlaying=true; this.nextNoteTime=audioCtx.currentTime; this.beatCount=0; this.scheduler(); },
    stop: function() { this.isPlaying=false; clearTimeout(this.timerID); },
    scheduler: function() { while(this.nextNoteTime<audioCtx.currentTime+0.1){ this.playBeat(this.nextNoteTime, this.beatCount); this.scheduleNextBeat(); } if(this.isPlaying)this.timerID=setTimeout(()=>this.scheduler(),25); },
    scheduleNextBeat: function() { this.nextNoteTime+=60.0/this.tempo*0.25; this.beatCount++; },
    playBeat: function(time, beat) { if(beat%4===0)this.playKick(time); if(beat%4===2)this.playHat(time); if(beat%16===4||beat%16===12)this.playSnare(time); if(beat%2===0){const idx=Math.floor(beat/16)%this.bassNotes.length;this.playBass(time,440*Math.pow(2,(this.bassNotes[idx]-69)/12));} },
    playKick: (t)=>{const o=audioCtx.createOscillator();const g=audioCtx.createGain();o.frequency.setValueAtTime(150,t);o.frequency.exponentialRampToValueAtTime(0.01,t+0.5);g.gain.setValueAtTime(1,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.5);o.connect(g);g.connect(audioCtx.destination);o.start(t);o.stop(t+0.5);},
    playSnare: (t)=>{const b=audioCtx.createBuffer(1,audioCtx.sampleRate*0.2,audioCtx.sampleRate);const d=b.getChannelData(0);for(let i=0;i<b.length;i++)d[i]=Math.random()*2-1;const s=audioCtx.createBufferSource();s.buffer=b;const g=audioCtx.createGain();const f=audioCtx.createBiquadFilter();f.type='highpass';f.frequency.value=1000;g.gain.setValueAtTime(0.5,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.2);s.connect(f);f.connect(g);g.connect(audioCtx.destination);s.start(t);},
    playHat: (t)=>{const o=audioCtx.createOscillator();o.type='square';o.frequency.value=4000;const g=audioCtx.createGain();const f=audioCtx.createBiquadFilter();f.type='bandpass';f.frequency.value=10000;g.gain.setValueAtTime(0.1,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.05);o.connect(f);f.connect(g);g.connect(audioCtx.destination);o.start(t);o.stop(t+0.05);},
    playBass: (t,f)=>{const o=audioCtx.createOscillator();o.type='sawtooth';o.frequency.setValueAtTime(f,t);const g=audioCtx.createGain();const fl=audioCtx.createBiquadFilter();fl.type='lowpass';fl.frequency.setValueAtTime(800,t);fl.frequency.exponentialRampToValueAtTime(200,t+0.2);g.gain.setValueAtTime(0.3,t);g.gain.linearRampToValueAtTime(0,t+0.2);o.connect(fl);fl.connect(g);g.connect(audioCtx.destination);o.start(t);o.stop(t+0.2);}
};

const SFX = {
    play: (freq, type, dur, vol=0.1) => { const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type=type; o.frequency.setValueAtTime(freq,audioCtx.currentTime); g.gain.setValueAtTime(vol,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+dur); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+dur); },
    shoot: (type) => {
        if(type==='pistol') SFX.play(600,'triangle',0.1,0.1);
        if(type==='shotgun') { SFX.play(150,'sawtooth',0.3,0.2); SFX.play(100,'square',0.2,0.2); }
        if(type==='rifle') SFX.play(500,'square',0.08,0.08);
        if(type==='minigun') SFX.play(400,'sawtooth',0.05,0.1);
        if(type==='rocket') { SFX.play(200,'sawtooth',0.5,0.2); SFX.play(50,'square',1.0,0.5); }
        if(type==='bouncer') SFX.play(800,'sine',0.1,0.2);
        if(type==='laser') { const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.frequency.setValueAtTime(2000,audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(100,audioCtx.currentTime+0.3); g.gain.setValueAtTime(0.2,audioCtx.currentTime); g.gain.linearRampToValueAtTime(0,audioCtx.currentTime+0.3); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.3); }
    },
    nuke: () => { const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type = 'lowpass'; o.frequency.value = 50; SFX.play(50, 'sawtooth', 3.0, 0.8); SFX.play(100, 'square', 1.0, 0.5); },
    build: () => SFX.play(1200,'sine',0.1,0.3),
    error: () => SFX.play(150,'sawtooth',0.2,0.2),
    buy: () => SFX.play(1000,'square',0.1,0.2),
    explode: () => { const b=audioCtx.createBuffer(1,audioCtx.sampleRate*0.5,audioCtx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<b.length;i++)d[i]=Math.random()*2-1; const s=audioCtx.createBufferSource(); s.buffer=b; const g=audioCtx.createGain(); g.gain.setValueAtTime(0.5,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.5); s.connect(g); g.connect(audioCtx.destination); s.start(); }
};

const canvas = document.querySelector('#gameCanvas');
const ctx = canvas.getContext('2d');
const WORLD_W = 2500, WORLD_H = 2500, TILE = 50;

let gameRunning = false;
let isShopOpen = false;
let score = 0;
let frame = 0;
let animationId;
let camera = { x: 0, y: 0 };

let player, projectiles, enemies, particles, walls, pickups, turrets;

const WEAPONS = {
    pistol: { name: 'PISTOL', color: '#facc15', cd: 20, speed: 14, dmg: 1, spread: 0.05, count: 1, ammo: Infinity },
    rifle: { name: 'ASSAULT RIFLE', color: '#a855f7', cd: 6, speed: 20, dmg: 0.8, spread: 0.15, count: 1, ammo: 120 },
    shotgun: { name: 'FLAK CANNON', color: '#ef4444', cd: 45, speed: 12, dmg: 1.2, spread: 0.5, count: 6, ammo: 20 },
    minigun: { name: 'MINIGUN', color: '#10b981', cd: 3, speed: 18, dmg: 0.5, spread: 0.25, count: 1, ammo: 300 },
    bouncer: { name: 'RICOCHET', color: '#ec4899', cd: 15, speed: 11, dmg: 2.5, spread: 0.05, count: 1, ammo: 25, type: 'bounce' },
    rocket: { name: 'RPG LAUNCHER', color: '#f97316', cd: 60, speed: 10, dmg: 10, spread: 0.05, count: 1, ammo: 10, explosive: true, radius: 120 },
    laser: { name: 'RAILGUN', color: '#22d3ee', cd: 70, speed: 0, dmg: 5, spread: 0, count: 1, ammo: 15, type: 'rail' }
};

const INPUT = { x: 0, y: 0, down: false, rightDown: false };
const KEYS = {};

class Player {
    constructor(x, y) {
        this.x = x; this.y = y; this.radius = 16; this.color = '#06b6d4';
        this.baseSpeed = 5.5; this.speed = 5.5; this.maxHealth = 100; this.health = 100;
        this.shield = 0; this.materials = 50; this.credits = 0; this.turretCount = 0;
        this.weapon = 'pistol'; this.ammo = Infinity; this.cd = 0; this.angle = 0;
    }

    update() {
        if (this.weapon === 'minigun' && INPUT.down && this.ammo > 0) this.speed = this.baseSpeed * 0.5;
        else this.speed = this.baseSpeed;

        let dx = 0, dy = 0;
        if (KEYS['w']) dy -= 1; if (KEYS['s']) dy += 1; if (KEYS['a']) dx -= 1; if (KEYS['d']) dx += 1;

        if (dx !== 0 || dy !== 0) {
            const len = Math.hypot(dx, dy); dx /= len; dy /= len;
            const moveX = dx * this.speed; const moveY = dy * this.speed;
            if (!this.checkCol(this.x + moveX, this.y)) this.x += moveX;
            if (!this.checkCol(this.x, this.y + moveY)) this.y += moveY;
        }

        this.x = Math.max(this.radius, Math.min(WORLD_W - this.radius, this.x));
        this.y = Math.max(this.radius, Math.min(WORLD_H - this.radius, this.y));
        this.angle = Math.atan2((INPUT.y + camera.y) - this.y, (INPUT.x + camera.x) - this.x);

        if (this.cd > 0) this.cd--;
        if (frame % 120 === 0 && this.shield < 50) this.shield = Math.min(50, this.shield + 1);
    }

    checkCol(x, y) {
        const r = { x: x - this.radius, y: y - this.radius, w: this.radius*2, h: this.radius*2 };
        return walls.some(w => checkRectOverlap(r, w));
    }

    draw() {
        ctx.save(); ctx.translate(this.x - camera.x, this.y - camera.y); ctx.rotate(this.angle);
        ctx.fillStyle = WEAPONS[this.weapon].color;
        if (this.weapon === 'minigun') { ctx.fillRect(0, -6, this.radius + 18, 12); ctx.fillStyle = '#000'; ctx.fillRect(this.radius + 18, -6, 4, 12); } 
        else if (this.weapon === 'rocket') { ctx.fillRect(0, -8, this.radius + 16, 16); } 
        else { ctx.fillRect(0, -4, this.radius + 14, 8); }
        ctx.beginPath(); ctx.arc(0, 0, this.radius, 0, Math.PI * 2); ctx.fillStyle = this.color; ctx.shadowColor = this.color; ctx.shadowBlur = 15; ctx.fill();
        if (this.shield > 0) { ctx.beginPath(); ctx.arc(0, 0, this.radius + 6, 0, Math.PI * 2); ctx.strokeStyle = `rgba(100, 200, 255, ${this.shield/50})`; ctx.lineWidth = 2; ctx.stroke(); }
        ctx.restore();
    }
}

class Turret {
    constructor(x, y) { this.x = x; this.y = y; this.radius = 15; this.angle = 0; this.cd = 0; this.target = null; this.health = 50; }
    update() {
        let minDist = 400; this.target = null;
        for(let e of enemies) { const d = Math.hypot(e.x - this.x, e.y - this.y); if (d < minDist) { minDist = d; this.target = e; } }
        if (this.target) {
            this.angle = Math.atan2(this.target.y - this.y, this.target.x - this.x);
            if (this.cd <= 0) { projectiles.push(new Projectile(this.x, this.y, 4, '#fbbf24', {x: Math.cos(this.angle)*15, y: Math.sin(this.angle)*15}, 0.5)); this.cd = 15; SFX.play(800, 'triangle', 0.05, 0.05); }
        } else { this.angle += 0.05; }
        if (this.cd > 0) this.cd--;
    }
    draw() {
        const dx = this.x - camera.x; const dy = this.y - camera.y;
        if (dx < -50 || dx > canvas.width+50 || dy < -50 || dy > canvas.height+50) return;
        ctx.save(); ctx.translate(dx, dy); ctx.fillStyle = '#333'; ctx.beginPath(); ctx.arc(0,0, 12, 0, Math.PI*2); ctx.fill();
        ctx.rotate(this.angle); ctx.fillStyle = '#fbbf24'; ctx.fillRect(-5, -5, 20, 10); ctx.beginPath(); ctx.arc(0,0, 8, 0, Math.PI*2); ctx.fill(); ctx.restore();
    }
}

class Projectile {
    constructor(x, y, r, c, vel, dmg, type='normal', meta={}) {
        this.x = x; this.y = y; this.r = r; this.color = c; this.vel = vel; this.dmg = dmg; this.type = type; this.meta = meta; this.life = 100; this.markedForDelete = false; this.bounces = 2;
    }
    update() {
        const prevX = this.x; const prevY = this.y;
        this.x += this.vel.x; this.y += this.vel.y; this.life--;
        for (let w of walls) {
            if (this.x > w.x && this.x < w.x + w.w && this.y > w.y && this.y < w.y + w.h) {
                if (this.type === 'bounce' && this.bounces > 0) {
                    this.bounces--; this.x = prevX; this.y = prevY;
                    if (this.x + this.vel.x > w.x && this.x + this.vel.x < w.x + w.w) this.vel.y = -this.vel.y; else this.vel.x = -this.vel.x;
                    createParticles(this.x, this.y, this.color, 2, 1); return;
                }
                this.explode(); if (w.destructible) w.health -= this.dmg * 5; break;
            }
        }
        if (this.life <= 0) this.markedForDelete = true;
    }
    explode() {
        this.markedForDelete = true;
        if (this.type === 'rocket') { SFX.explode(); createParticles(this.x, this.y, '#f97316', 20, 5); particles.push({x: this.x, y: this.y, life: 20, maxLife: 20, type: 'shockwave', r: this.meta.radius}); enemies.forEach(e => { if (Math.hypot(e.x - this.x, e.y - this.y) < this.meta.radius) e.takeDamage(this.dmg); }); } 
        else { createParticles(this.x, this.y, this.color, 3, 2); }
    }
    draw() {
        const dx = this.x - camera.x; const dy = this.y - camera.y;
        if (this.type === 'rocket') { ctx.fillStyle = '#f97316'; ctx.beginPath(); ctx.arc(dx, dy, 6, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.moveTo(dx, dy); ctx.lineTo(dx - this.vel.x*3, dy - this.vel.y*3); ctx.strokeStyle = 'rgba(255,100,0,0.5)'; ctx.lineWidth = 4; ctx.stroke(); } 
        else if (this.type === 'bounce') { ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(dx, dy, 5, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle = 'rgba(236, 72, 153, 0.5)'; ctx.beginPath(); ctx.arc(dx, dy, 8, 0, Math.PI*2); ctx.stroke(); } 
        else { ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(dx, dy, this.r, 0, Math.PI*2); ctx.fill(); }
    }
}

class Enemy {
    constructor(x, y, type) {
        this.x = x; this.y = y; this.type = type;
        this.radius = type === 'tank' ? 26 : (type === 'speed' ? 12 : 18);
        this.color = type === 'tank' ? '#a855f7' : (type === 'speed' ? '#fbbf24' : '#ef4444');
        this.speed = type === 'tank' ? 1.2 : (type === 'speed' ? 4.2 : 2.2);
        this.hp = type === 'tank' ? 25 : (type === 'speed' ? 2 : 5);
        this.maxHp = this.hp; this.flash = 0;
    }
    takeDamage(amount) {
        if (this.hp <= 0) return false;
        this.hp -= amount; this.flash = 3;
        if (this.hp <= 0) {
            score += (this.type==='tank'?50:10); 
            player.materials += (this.type==='tank'?15:5);
            // --- æ–°å¢: è·å–ä¿¡ç”¨ç‚¹ ---
            player.credits += (this.type==='tank'?25:10);
            updateUI();
            createParticles(this.x, this.y, this.color, 10, 4);
            let dropChance = 0.15; if (this.type === 'tank') dropChance = 0.5;
            if(Math.random() < dropChance) spawnPickup(this.x, this.y);
            return true;
        }
        return false;
    }
    update() {
        const dx = player.x - this.x; const dy = player.y - this.y; const d = Math.hypot(dx, dy);
        let vx = (dx / d) * this.speed; let vy = (dy / d) * this.speed;
        enemies.forEach(e => { if (e === this) return; const edx = this.x - e.x; const edy = this.y - e.y; const dist = Math.hypot(edx, edy); if (dist < this.radius * 2) { const push = (this.radius*2 - dist) / dist; vx += edx * push * 0.1; vy += edy * push * 0.1; } });
        turrets.forEach(t => { const tdx = t.x - this.x; const tdy = t.y - this.y; if (Math.hypot(tdx, tdy) < 30) { t.health -= 1; if(t.health <=0) { turrets = turrets.filter(tr => tr !== t); createParticles(t.x, t.y, '#333', 10, 5); SFX.explode(); } } });
        if (!this.checkCol(this.x + vx, this.y)) this.x += vx;
        if (!this.checkCol(this.x, this.y + vy)) this.y += vy;
        if (this.flash > 0) this.flash--;
    }
    checkCol(x, y) {
        const r = {x: x-this.radius, y: y-this.radius, w:this.radius*2, h:this.radius*2};
        for(let w of walls) { if (checkRectOverlap(r, w)) { if (w.destructible) { w.health -= 0.1; if (w.health <= 0) { walls = walls.filter(wall => wall !== w); createParticles(w.x + w.w/2, w.y + w.h/2, '#fbbf24', 5, 3); } } return true; } }
        return false;
    }
    draw() {
        const dx = this.x - camera.x; const dy = this.y - camera.y;
        if (dx < -50 || dx > canvas.width+50 || dy < -50 || dy > canvas.height+50) return;
        ctx.save(); ctx.translate(dx, dy); ctx.rotate(Math.atan2(player.y - this.y, player.x - this.x));
        ctx.fillStyle = this.flash > 0 ? 'white' : this.color; ctx.shadowBlur = 10; ctx.shadowColor = this.color;
        if (this.type === 'tank') ctx.fillRect(-this.radius, -this.radius, this.radius*2, this.radius*2);
        else if (this.type === 'speed') { ctx.beginPath(); ctx.moveTo(this.radius,0); ctx.lineTo(-this.radius, -this.radius); ctx.lineTo(-this.radius, this.radius); ctx.fill(); }
        else { ctx.beginPath(); ctx.arc(0,0,this.radius,0,Math.PI*2); ctx.fill(); }
        ctx.restore();
    }
}

function checkRectOverlap(r1, r2) { return r1.x < r2.x + r2.w && r1.x + r1.w > r2.x && r1.y < r2.y + r2.h && r1.y + r1.h > r2.y; }

function createParticles(x, y, color, count, speed) {
    for(let i=0; i<count; i++) { const angle = Math.random() * Math.PI * 2; const s = Math.random() * speed; particles.push({ x: x, y: y, vx: Math.cos(angle)*s, vy: Math.sin(angle)*s, life: 1.0, color: color, type: 'normal' }); }
}

function spawnPickup(x, y) {
    if (x === undefined) x = Math.random() * (WORLD_W - 200) + 100;
    if (y === undefined) y = Math.random() * (WORLD_H - 200) + 100;
    const w = Math.random();
    let type = 'ammo';
    // --- è°ƒæ•´ï¼šè‡ªåŠ¨ç‚®å° (turret) çš„ç”Ÿæˆç‡æé«˜ ---
    // ä¹‹å‰æ˜¯ >0.85 (15% range), ç°åœ¨è°ƒæ•´ä¸ºè¦†ç›–æ›´å¹¿çš„èŒƒå›´ï¼Œä¾‹å¦‚ 0.8 åˆ° 0.9 (10%)
    // å®é™…ä¸Šä¹‹å‰çš„é€»è¾‘: nuke(2%), minigun(8%), turret(5%), bouncer(5%)...
    // æ–°é€»è¾‘: 
    if (w > 0.98) type = 'nuke';
    else if (w > 0.90) type = 'minigun';
    else if (w > 0.80) type = 'turret'; // å¢åŠ åˆ° 10% å‡ ç‡ (0.80 - 0.90)
    else if (w > 0.75) type = 'bouncer';
    else if (w > 0.70) type = 'laser';
    else if (w > 0.65) type = 'rocket';
    else if (w > 0.55) type = 'shield';
    else if (w > 0.45) type = 'health';
    else if (w > 0.25) type = 'shotgun';
    else if (w > 0.10) type = 'rifle';
    
    pickups.push({ x: x, y: y, type: type, bob: 0 });
}

function triggerNuke() {
    SFX.nuke();
    const flash = document.getElementById('flash-layer'); flash.style.opacity = 1; setTimeout(() => flash.style.opacity = 0, 1000);
    enemies.forEach(e => { if (e.type !== 'tank') { e.hp = 0; createParticles(e.x, e.y, e.color, 10, 5); } else { e.takeDamage(50); } });
    let kills = enemies.filter(e => e.hp <= 0).length; score += kills * 20; updateUI();
    showMsg("TACTICAL NUKE DETONATED", "text-red-600");
}

function updateUI() {
    document.getElementById('scoreEl').innerText = score;
    document.getElementById('materialEl').innerText = Math.floor(player.materials);
    document.getElementById('creditsEl').innerText = Math.floor(player.credits);
    document.getElementById('shopCredits').innerText = Math.floor(player.credits);
    
    document.getElementById('healthBar').style.width = `${player.health}%`;
    document.getElementById('shieldBar').style.width = `${player.shield}%`;
    document.getElementById('healthText').innerText = Math.ceil(player.health) + "%";
    const wData = WEAPONS[player.weapon];
    document.getElementById('weaponName').innerText = wData.name;
    document.getElementById('weaponName').style.color = wData.color;
    document.getElementById('ammoEl').innerText = player.ammo === Infinity ? 'âˆ' : player.ammo;
    document.getElementById('turretCount').innerText = player.turretCount;
    document.getElementById('turretStatus').style.opacity = player.turretCount > 0 ? 1 : 0;
}

function showMsg(text, colorClass) {
    const el = document.getElementById('pickupName'); const msg = document.getElementById('pickupMsg');
    el.innerText = text; el.className = `font-bold ${colorClass}`;
    msg.style.opacity = 1; setTimeout(() => msg.style.opacity = 0, 1500);
}

function toggleShop() {
    if (!gameRunning && document.getElementById('startMenu').classList.contains('hidden')) {
        // å¦‚æœæ¸¸æˆæ²¡åœ¨è¿è¡Œä¸”ä¸åœ¨ä¸»èœå• (ç†è®ºä¸Šä¸åº”å‘ç”Ÿï¼Œé™¤éæš‚åœé€»è¾‘å¤æ‚)
        return;
    }
    if (!gameRunning && !isShopOpen) return; // æ¸¸æˆç»“æŸæˆ–æœªå¼€å§‹ä¸èƒ½å¼€åº—

    const shop = document.getElementById('shopMenu');
    isShopOpen = !isShopOpen;
    
    if (isShopOpen) {
        shop.classList.remove('hidden');
        updateUI(); // ç¡®ä¿æ˜¾ç¤ºæœ€æ–°ä½™é¢
    } else {
        shop.classList.add('hidden');
    }
}

function buyItem(item) {
    if (!player) return;
    let cost = 0;
    let success = false;

    if (item === 'repair') {
        cost = 100;
        if (player.credits >= cost && player.health < 100) {
            player.credits -= cost;
            player.health = Math.min(100, player.health + 50);
            success = true;
            showMsg("æœºä½“å·²ä¿®å¤", "text-green-400");
        }
    } else if (item === 'ammo') {
        cost = 50;
        if (player.credits >= cost && player.weapon !== 'pistol') {
            player.credits -= cost;
            player.ammo = WEAPONS[player.weapon].ammo;
            success = true;
            showMsg("å¼¹è¯å·²è£…å¡«", "text-white");
        }
    } else if (item === 'shield') {
        cost = 150;
        if (player.credits >= cost) {
            player.credits -= cost;
            player.shield = Math.min(100, player.shield + 50);
            success = true;
            showMsg("æŠ¤ç›¾å……èƒ½å®Œæ¯•", "text-blue-400");
        }
    } else if (item === 'turret') {
        cost = 200;
        if (player.credits >= cost) {
            player.credits -= cost;
            player.turretCount++;
            success = true;
            showMsg("ç‚®å°ç³»ç»Ÿä¸Šçº¿", "text-yellow-400");
        }
    } else if (item === 'material') {
        cost = 75;
        if (player.credits >= cost) {
            player.credits -= cost;
            player.materials += 50;
            success = true;
            showMsg("çº³ç±³ææ–™è·å–", "text-orange-400");
        }
    } else if (item === 'nuke') {
        cost = 1000;
        if (player.credits >= cost) {
            player.credits -= cost;
            triggerNuke();
            success = true;
            toggleShop(); // è´­ä¹°æ ¸å¼¹åè‡ªåŠ¨å…³é—­å•†åº—è§‚çœ‹æ•ˆæœ
        }
    }

    if (success) {
        SFX.buy();
        updateUI();
    } else {
        SFX.error();
    }
}

function initGame() {
    score = 0; walls = [];
    walls.push({x:-50, y:-50, w:WORLD_W+100, h:50, destructible:false});
    walls.push({x:-50, y:WORLD_H, w:WORLD_W+100, h:50, destructible:false});
    walls.push({x:-50, y:0, w:50, h:WORLD_H, destructible:false});
    walls.push({x:WORLD_W, y:0, w:50, h:WORLD_H, destructible:false});
    for(let i=0; i<25; i++) {
        const w = Math.random()*200 + 50; const h = Math.random()*200 + 50;
        const x = Math.random()*(WORLD_W-w-200) + 100; const y = Math.random()*(WORLD_H-h-200) + 100;
        if(Math.hypot(x-WORLD_W/2, y-WORLD_H/2) > 300) { walls.push({x, y, w, h, destructible:false, color: 'rgba(6, 182, 212, 0.1)'}); }
    }
    player = new Player(WORLD_W/2, WORLD_H/2);
    enemies = []; projectiles = []; particles = []; pickups = []; turrets = [];
    for(let i=0; i<10; i++) spawnPickup();
    camera.x = player.x - canvas.width/2; camera.y = player.y - canvas.height/2;
    updateUI();
}

function spawnEnemy() {
    let attempts = 0; let safe = false; let x, y, dist, ang;
    while (!safe && attempts < 20) {
        attempts++; ang = Math.random()*Math.PI*2; dist = canvas.width/2 + 100 + Math.random() * 200;
        x = Math.max(50, Math.min(WORLD_W-50, player.x + Math.cos(ang)*dist));
        y = Math.max(50, Math.min(WORLD_H-50, player.y + Math.sin(ang)*dist));
        const testRect = { x: x-20, y: y-20, w: 40, h: 40 };
        let collision = false;
        for (let w of walls) { if (checkRectOverlap(testRect, w)) { collision = true; break; } }
        if (Math.hypot(player.x - x, player.y - y) < 400) collision = true;
        if (!collision) safe = true;
    }
    if (safe) {
        let type = 'normal';
        if (score > 500 && Math.random() < 0.25) type = 'tank';
        else if (score > 200 && Math.random() < 0.35) type = 'speed';
        enemies.push(new Enemy(x, y, type));
    }
}

function animate() {
    // å¦‚æœå•†åº—æ‰“å¼€ï¼Œæš‚åœæ¸¸æˆé€»è¾‘ï¼Œä½†ä¿æŒæ¸²æŸ“ï¼ˆå¦‚æœéœ€è¦å†»ç»“ç”»é¢ï¼‰æˆ–è€…å®Œå…¨åœæ­¢
    // è¿™é‡Œæˆ‘ä»¬é€‰æ‹©å®Œå…¨åœæ­¢æ›´æ–°å¾ªç¯ï¼Œåªæ¸²æŸ“é™æ€ç”»é¢æˆ–è€…ç›´æ¥åœæ­¢
    // ä¸ºäº†ç®€å•ï¼Œå¦‚æœ shop openï¼Œç›´æ¥ returnï¼Œä½†è¿™ä¼šå¯¼è‡´ç”»é¢å†»ç»“ã€‚
    // æ›´å¥½çš„åšæ³•æ˜¯ï¼šå¦‚æœä¸ runningï¼Œä¸æ‰§è¡Œ updateï¼Œåªæ‰§è¡Œ drawï¼Ÿ
    // é‰´äºç»“æ„ï¼Œç®€å•çš„åšæ³•æ˜¯ï¼šå¦‚æœ shopOpenï¼Œä¸è°ƒç”¨ requestAnimationFrameï¼Œæˆ–è€…åœ¨å¼€å¤´ returnã€‚
    // ä½†ä¸ºäº†è®©èƒŒæ™¯çœ‹èµ·æ¥è¿˜åœ¨ï¼ˆå†»ç»“ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ toggleShop é‡Œå¤„ç†ã€‚
    // è¿™é‡Œé‡‡ç”¨ï¼šåªåœ¨ !isShopOpen æ—¶ update å’Œ requestNextFrame
    
    if (!gameRunning) return;

    if (isShopOpen) {
        // å•†åº—æ‰“å¼€æ—¶ï¼Œæš‚åœæ¸¸æˆå¾ªç¯ï¼Œä½†ä¿æŒ requestAnimationFrame ä»¥ä¾¿éšæ—¶æ¢å¤ï¼Ÿ
        // æˆ–è€…ç›´æ¥ä¸è¯·æ±‚ä¸‹ä¸€å¸§ã€‚å½“å…³é—­å•†åº—æ—¶å†å¯åŠ¨ animate()ã€‚
        // æˆ‘ä»¬é‡‡ç”¨åè€…ï¼Œåœ¨ toggleShop é‡Œé‡å¯ã€‚
        return; 
    }

    animationId = requestAnimationFrame(animate); frame++;
    camera.x += (player.x - canvas.width/2 - camera.x) * 0.1; camera.y += (player.y - canvas.height/2 - camera.y) * 0.1;
    ctx.fillStyle = '#050505'; ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    const startX = Math.floor(camera.x/TILE)*TILE; const startY = Math.floor(camera.y/TILE)*TILE;
    ctx.strokeStyle = 'rgba(20, 20, 30, 0.5)'; ctx.lineWidth = 1; ctx.beginPath();
    for(let x=startX; x<camera.x+canvas.width; x+=TILE) { ctx.moveTo(x-camera.x, 0); ctx.lineTo(x-camera.x, canvas.height); }
    for(let y=startY; y<camera.y+canvas.height; y+=TILE) { ctx.moveTo(0, y-camera.y); ctx.lineTo(canvas.width, y-camera.y); }
    ctx.stroke();

    walls.forEach(w => {
        const dx = w.x - camera.x; const dy = w.y - camera.y;
        if(dx+w.w < 0 || dx > canvas.width || dy+w.h < 0 || dy > canvas.height) return;
        ctx.save(); ctx.translate(dx, dy);
        if(w.destructible) {
            ctx.strokeStyle = '#fbbf24'; ctx.lineWidth = 2; ctx.shadowColor = '#fbbf24'; ctx.shadowBlur = 10;
            ctx.strokeRect(0,0,w.w,w.h); ctx.fillStyle = `rgba(251, 191, 36, ${w.health/w.maxHealth * 0.3})`; ctx.fillRect(0,0,w.w,w.h);
            ctx.fillStyle = 'red'; ctx.fillRect(5, -10, w.w-10, 4); ctx.fillStyle = '#0f0'; ctx.fillRect(5, -10, (w.w-10)*(w.health/w.maxHealth), 4);
        } else {
            ctx.strokeStyle = '#06b6d4'; ctx.lineWidth = 2; ctx.shadowColor = '#06b6d4'; ctx.shadowBlur = 10;
            ctx.fillStyle = w.color || 'rgba(6,182,212,0.1)'; ctx.strokeRect(0,0,w.w,w.h); ctx.fillRect(0,0,w.w,w.h);
        }
        ctx.restore();
    });

    if (INPUT.rightDown) {
        const mx = INPUT.x + camera.x; const my = INPUT.y + camera.y;
        const bx = Math.floor(mx/TILE)*TILE; const by = Math.floor(my/TILE)*TILE;
        ctx.save(); ctx.translate(bx - camera.x, by - camera.y);
        ctx.strokeStyle = player.materials >= 10 ? 'lime' : 'red'; ctx.lineWidth = 2; ctx.setLineDash([4, 4]);
        ctx.strokeRect(0,0,TILE,TILE); ctx.restore();
    }

    player.update();
    
    if (INPUT.down) {
        const w = WEAPONS[player.weapon];
        if (player.cd <= 0 && (player.ammo > 0 || w.ammo === Infinity)) {
            player.cd = w.cd; if(w.ammo !== Infinity) player.ammo--; updateUI();
            if (player.weapon === 'laser') {
                SFX.shoot('laser');
                const endX = player.x + Math.cos(player.angle) * 800; const endY = player.y + Math.sin(player.angle) * 800;
                particles.push({type:'beam', x1:player.x, y1:player.y, x2:endX, y2:endY, life:10, color:'#22d3ee'});
                enemies.forEach(e => {
                    const A = player.x - e.x; const B = player.y - e.y; const C = endX - player.x; const D = endY - player.y;
                    const dot = A * C + B * D; const len_sq = C * C + D * D; const param = -dot / len_sq;
                    let xx, yy; if (param < 0) { xx = player.x; yy = player.y; } else if (param > 1) { xx = endX; yy = endY; } else { xx = player.x + param * C; yy = player.y + param * D; }
                    if (Math.hypot(e.x - xx, e.y - yy) < e.radius + 10) e.takeDamage(w.dmg);
                });
            } else {
                SFX.shoot(player.weapon);
                for(let i=0; i<w.count; i++) {
                    const ang = player.angle + (Math.random()-0.5)*w.spread;
                    const v = {x:Math.cos(ang)*w.speed, y:Math.sin(ang)*w.speed};
                    const type = (player.weapon === 'rocket' ? 'rocket' : (player.weapon === 'bouncer' ? 'bounce' : 'normal'));
                    projectiles.push(new Projectile(player.x + Math.cos(ang)*25, player.y + Math.sin(ang)*25, 4, w.color, v, w.dmg, type, player.weapon === 'rocket' ? {radius: w.radius} : {}));
                }
                const recoilAmt = (player.weapon === 'shotgun' ? 5 : 2);
                const rx = -Math.cos(player.angle) * recoilAmt;
                const ry = -Math.sin(player.angle) * recoilAmt;
                if (!player.checkCol(player.x + rx, player.y)) player.x += rx;
                if (!player.checkCol(player.x, player.y + ry)) player.y += ry;
            }
        } else if (player.ammo <= 0 && w.ammo !== Infinity) {
            player.weapon = 'pistol'; player.ammo = Infinity; updateUI();
        }
    }

    turrets.forEach(t => { t.update(); t.draw(); });
    projectiles.forEach(p => { p.update(); p.draw(); }); projectiles = projectiles.filter(p => !p.markedForDelete);
    particles.forEach((p, i) => {
        if(p.type === 'beam') { ctx.save(); ctx.translate(-camera.x, -camera.y); ctx.beginPath(); ctx.moveTo(p.x1, p.y1); ctx.lineTo(p.x2, p.y2); ctx.lineWidth = p.life; ctx.strokeStyle = `rgba(34, 211, 238, ${p.life/10})`; ctx.shadowBlur = 20; ctx.shadowColor = p.color; ctx.stroke(); ctx.restore(); p.life--; } 
        else if (p.type === 'shockwave') { ctx.save(); ctx.translate(p.x - camera.x, p.y - camera.y); ctx.beginPath(); ctx.arc(0,0, p.r * (1 - p.life/p.maxLife), 0, Math.PI*2); ctx.strokeStyle = `rgba(249, 115, 22, ${p.life/p.maxLife})`; ctx.lineWidth = 3; ctx.stroke(); ctx.restore(); p.life--; } 
        else { p.x += p.vx; p.y += p.vy; p.life -= 0.05; ctx.save(); ctx.translate(p.x - camera.x, p.y - camera.y); ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(0,0, 3, 0, Math.PI*2); ctx.fill(); ctx.restore(); }
    });
    particles = particles.filter(p => p.life > 0);
    pickups.forEach((p, i) => {
        const bob = Math.sin(frame*0.1)*5;
        const dx = p.x-camera.x; const dy = p.y-camera.y + bob;
        if (dx > -50 && dx < canvas.width+50 && dy > -50 && dy < canvas.height+50) {
             ctx.save(); ctx.translate(dx, dy);
             ctx.fillStyle = (p.type==='nuke'?'#ff0000':(p.type==='ammo'?'#fff':(p.type==='health'?'#22c55e':WEAPONS[p.type]?WEAPONS[p.type].color:'#22d3ee')));
             if(p.type === 'shield') ctx.fillStyle = '#60a5fa';
             if(p.type === 'turret') ctx.fillStyle = '#fbbf24';
             ctx.shadowBlur = 10; ctx.shadowColor = ctx.fillStyle; ctx.font = "20px Arial"; ctx.textAlign = "center"; 
             let icon = "?"; if(p.type==='health') icon = "âœš"; if(p.type==='shield') icon = "ğŸ›¡"; if(p.type==='ammo') icon = "â‘Š"; if(p.type==='turret') icon = "â™œ"; if(p.type==='nuke') icon = "â˜¢"; if(WEAPONS[p.type]) icon = "ğŸ”«";
             ctx.fillText(icon, 0, 8); ctx.strokeStyle = ctx.fillStyle; ctx.lineWidth=2; ctx.strokeRect(-12,-12,24,24); ctx.restore();
        }
        if (Math.hypot(player.x - p.x, player.y - p.y) < player.radius + 15) {
            if (p.type === 'nuke') { triggerNuke(); } else {
                SFX.play(1000, 'sine', 0.1, 0.1);
                if (p.type === 'health') { player.health = Math.min(100, player.health+30); showMsg("HP æ¢å¤", "text-green-400"); }
                else if (p.type === 'shield') { player.shield = Math.min(100, player.shield+50); showMsg("èƒ½é‡æŠ¤ç›¾", "text-blue-400"); }
                else if (p.type === 'ammo') { player.ammo += 50; showMsg("å¼¹è¯è¡¥ç»™", "text-white"); }
                else if (p.type === 'turret') { player.turretCount++; showMsg("è‡ªåŠ¨ç‚®å°", "text-yellow-400"); }
                else { player.weapon = p.type; player.ammo = WEAPONS[p.type].ammo; showMsg(WEAPONS[p.type].name, "text-purple-400"); }
                updateUI();
            }
            pickups.splice(i, 1);
        }
    });
    enemies.forEach((e) => {
        e.update(); e.draw();
        projectiles.forEach(p => {
            if (p.markedForDelete) return;
            const dist = Math.hypot(e.x - p.x, e.y - p.y);
            if (dist < e.radius + p.r) { if (p.type !== 'rocket') e.takeDamage(p.dmg); p.explode(); }
        });
        if (Math.hypot(player.x - e.x, player.y - e.y) < player.radius + e.radius) {
            let dmg = 0.5; if (player.shield > 0) { player.shield -= dmg; if(player.shield < 0) { player.health += player.shield; player.shield = 0; } } else { player.health -= dmg; }
            updateUI();
            if (frame % 20 === 0) SFX.play(100, 'sawtooth', 0.1, 0.1);
            if (player.health <= 0) {
                gameRunning = false; BGM.stop();
                document.getElementById('startMenu').classList.remove('hidden'); 
                document.getElementById('finalScoreContainer').classList.remove('hidden'); 
                document.getElementById('finalScore').innerText = score; 
                document.querySelector('#startBtnText').innerText = "REBOOT SYSTEM";
                document.getElementById('returnToTitleBtn').classList.remove('hidden'); // æ˜¾ç¤ºè¿”å›æŒ‰é’®
            }
        }
    });
    enemies = enemies.filter(e => e.hp > 0);
    const spawnRate = Math.max(25, 90 - Math.floor(score/100)); if (frame % spawnRate === 0) spawnEnemy();
    player.draw();
}

window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
canvas.width = window.innerWidth; canvas.height = window.innerHeight;
window.addEventListener('keydown', e => {
    KEYS[e.key.toLowerCase()] = true;
    if (e.key.toLowerCase() === 'e') { if (player && player.turretCount > 0) { turrets.push(new Turret(player.x, player.y)); player.turretCount--; updateUI(); SFX.build(); } }
    if (e.key.toLowerCase() === 'b') { toggleShop(); }
});
window.addEventListener('keyup', e => KEYS[e.key.toLowerCase()] = false);
window.addEventListener('mousemove', e => { INPUT.x = e.clientX; INPUT.y = e.clientY; });
window.addEventListener('mousedown', e => {
    if (e.button === 0) INPUT.down = true;
    if (e.button === 2) {
        INPUT.rightDown = true;
        const mx = INPUT.x + camera.x; const my = INPUT.y + camera.y;
        const bx = Math.floor(mx/TILE)*TILE; const by = Math.floor(my/TILE)*TILE;
        const exists = walls.some(w => w.x === bx && w.y === by);
        const pRect = {x: player.x-20, y: player.y-20, w:40, h:40};
        const wRect = {x: bx, y: by, w: TILE, h: TILE};
        const overlapPlayer = checkRectOverlap(pRect, wRect);
        if (!exists && !overlapPlayer && player.materials >= 10) { walls.push({ x: bx, y: by, w: TILE, h: TILE, destructible: true, health: 50, maxHealth: 50 }); player.materials -= 10; updateUI(); SFX.build(); createParticles(bx+25, by+25, '#fbbf24', 5, 2); } 
        else if (player.materials < 10 && !exists && !overlapPlayer) { SFX.error(); showMsg("ææ–™ä¸è¶³!", "text-red-500"); }
    }
});
window.addEventListener('mouseup', e => { if (e.button === 0) INPUT.down = false; if (e.button === 2) INPUT.rightDown = false; });
window.addEventListener('contextmenu', e => e.preventDefault());

document.getElementById('startBtn').addEventListener('click', () => {
    document.getElementById('startMenu').classList.add('hidden');
    // Reset game over state UI
    document.getElementById('finalScoreContainer').classList.add('hidden');
    document.getElementById('returnToTitleBtn').classList.add('hidden');
    gameRunning = true; isShopOpen = false;
    BGM.start(); initGame(); animate();
});

// Return to Title Button
document.getElementById('returnToTitleBtn').addEventListener('click', () => {
    // Reset to initial state
    document.getElementById('finalScoreContainer').classList.add('hidden');
    document.getElementById('returnToTitleBtn').classList.add('hidden');
    document.querySelector('#startBtnText').innerText = "INITIATE";
    // è¿™é‡Œä¸éœ€è¦åšå¤ªå¤šï¼Œå› ä¸ºå·²ç»åœ¨ startMenu é‡Œäº†ï¼Œåªéœ€é‡ç½®æ˜¾ç¤ºçŠ¶æ€å³å¯
});

const helpMenu = document.getElementById('helpMenu');
document.getElementById('helpBtn').addEventListener('click', () => helpMenu.classList.remove('hidden'));
document.getElementById('closeHelpBtn').addEventListener('click', () => helpMenu.classList.add('hidden'));

// Shop
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && isShopOpen) toggleShop();
});

// å•†åº—æ¢å¤æ¸¸æˆå¾ªç¯çš„ trick: å½“ toggle å…³é—­æ—¶è°ƒç”¨ animate
const originalToggleShop = toggleShop;
toggleShop = function() {
    if (!gameRunning && document.getElementById('startMenu').classList.contains('hidden')) return; // edge case
    if (!gameRunning && !isShopOpen) return;

    const shop = document.getElementById('shopMenu');
    isShopOpen = !isShopOpen;
    
    if (isShopOpen) {
        shop.classList.remove('hidden');
        updateUI();
    } else {
        shop.classList.add('hidden');
        // Resume game
        if(gameRunning) animate();
    }
};

initGame();
</script>
</body>
</html>
